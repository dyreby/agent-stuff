name: Roger Roger

on:
  workflow_dispatch:
    inputs:
      number:
        description: "PR or Issue number"
        type: string
        required: true
      prompt:
        description: "What should the agent do?"
        type: string
        required: true

jobs:
  respond:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get app token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.GH_BOT_APP_ID }}
          private-key: ${{ secrets.GH_BOT_PRIVATE_KEY }}

      - name: Record prompt
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          gh issue comment ${{ inputs.number }} \
            --body "> **@${{ vars.GH_BOT_HUMAN }}** (manual): ${{ inputs.prompt }}"

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-pi-v1

      - name: Run pi
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_BOT_APP_ID: ${{ vars.GH_BOT_APP_ID }}
          GH_BOT_INSTALLATION_ID: ${{ vars.GH_BOT_INSTALLATION_ID }}
          GH_BOT_PRIVATE_KEY: ${{ secrets.GH_BOT_PRIVATE_KEY }}
          GH_BOT_HUMAN: ${{ vars.GH_BOT_HUMAN }}
          GH_BOT_AGENT: ${{ vars.GH_BOT_AGENT }}
        run: |
          npx @mariozechner/pi-coding-agent@latest \
            -e ./pi-extensions/gh-bot \
            --mode json \
            -p "respond to #${{ inputs.number }}" > /tmp/pi-output.json 2>&1

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ¤– Agent Output" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          jq -rj 'select(.type == "message_update" and .assistantMessageEvent.type == "text_delta") | .assistantMessageEvent.delta' /tmp/pi-output.json 2>/dev/null >> $GITHUB_STEP_SUMMARY || cat /tmp/pi-output.json >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ’° Cost" >> $GITHUB_STEP_SUMMARY
          jq -s '
            [.[] | select(.type == "message_end") | .message.usage // empty] |
            {
              input: (map(.input // 0) | add // 0),
              output: (map(.output // 0) | add // 0),
              cacheRead: (map(.cacheRead // 0) | add // 0),
              cacheWrite: (map(.cacheWrite // 0) | add // 0)
            } |
            "- Input: \(.input) | Output: \(.output) | Cache read: \(.cacheRead) | Cache write: \(.cacheWrite)"
          ' /tmp/pi-output.json 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "No usage data" >> $GITHUB_STEP_SUMMARY
