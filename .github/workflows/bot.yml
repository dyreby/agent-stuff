name: Roger Roger

on:
  workflow_dispatch:
    inputs:
      number:
        description: "PR or Issue number"
        type: string
        required: true
      prompt:
        description: "What should the agent do?"
        type: string
        required: true

jobs:
  respond:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get app token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.GH_BOT_APP_ID }}
          private-key: ${{ secrets.GH_BOT_PRIVATE_KEY }}

      - name: Record prompt
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          gh issue comment ${{ inputs.number }} \
            --body "> **@${{ vars.GH_BOT_HUMAN }}** (manual): ${{ inputs.prompt }}"

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-pi-v1

      - name: Run pi
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_BOT_APP_ID: ${{ vars.GH_BOT_APP_ID }}
          GH_BOT_INSTALLATION_ID: ${{ vars.GH_BOT_INSTALLATION_ID }}
          GH_BOT_PRIVATE_KEY: ${{ secrets.GH_BOT_PRIVATE_KEY }}
          GH_BOT_HUMAN: ${{ vars.GH_BOT_HUMAN }}
          GH_BOT_AGENT: ${{ vars.GH_BOT_AGENT }}
        run: |
          npx @mariozechner/pi-coding-agent@latest \
            -e ./pi-extensions/gh-bot \
            -p "respond to #${{ inputs.number }}" 2>&1 | tee /tmp/pi-output.log

      - name: Cost summary
        run: |
          echo "## ðŸ’° Cost Summary" >> $GITHUB_STEP_SUMMARY
          grep -iE "(token|cost|input|output|cache|\\\$[0-9])" /tmp/pi-output.log >> $GITHUB_STEP_SUMMARY || echo "No cost data found" >> $GITHUB_STEP_SUMMARY
