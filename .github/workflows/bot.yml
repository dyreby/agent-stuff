name: Roger Roger

# Trigger on issue/PR activity that might contain a directive
on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
    types: [created]

concurrency:
  group: bot
  cancel-in-progress: false

jobs:
  respond:
    runs-on: ubuntu-latest

    # Gate: only run when human creates content mentioning @agent
    #
    # Each event type stores user and body in different locations:
    #   issue_comment             â†’ comment.user.login, comment.body
    #   issues                    â†’ issue.user.login, issue.body
    #   pull_request_review       â†’ review.user.login, review.body
    #   pull_request_review_comment â†’ comment.user.login, comment.body
    #
    # This condition is evaluated before a runner starts (efficient).
    if: |
      (github.event_name == 'issue_comment' && github.event.comment.user.login == vars.GH_BOT_HUMAN && contains(github.event.comment.body, format('@{0}', vars.GH_BOT_AGENT))) ||
      (github.event_name == 'issues' && github.event.issue.user.login == vars.GH_BOT_HUMAN && contains(github.event.issue.body, format('@{0}', vars.GH_BOT_AGENT))) ||
      (github.event_name == 'pull_request_review' && github.event.review.user.login == vars.GH_BOT_HUMAN && contains(github.event.review.body, format('@{0}', vars.GH_BOT_AGENT))) ||
      (github.event_name == 'pull_request_review_comment' && github.event.comment.user.login == vars.GH_BOT_HUMAN && contains(github.event.comment.body, format('@{0}', vars.GH_BOT_AGENT)))

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # For PR comments, checkout the PR branch so we test the latest code
          ref: ${{ github.event.issue.pull_request && format('refs/pull/{0}/head', github.event.issue.number) || '' }}

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-pi-v1

      - name: Determine context
        id: context
        run: |
          if [ -n "${{ github.event.issue.number }}" ]; then
            NUM="${{ github.event.issue.number }}"
            [[ -n "${{ github.event.issue.pull_request }}" ]] && PREFIX="pr" || PREFIX="issue"
          else
            NUM="${{ github.event.pull_request.number }}"
            PREFIX="pr"
          fi
          echo "prompt=respond to $PREFIX #$NUM" >> "$GITHUB_OUTPUT"

      - name: Debug env vars
        env:
          GH_BOT_APP_ID: ${{ vars.GH_BOT_APP_ID }}
          GH_BOT_INSTALLATION_ID: ${{ vars.GH_BOT_INSTALLATION_ID }}
          GH_BOT_PRIVATE_KEY: ${{ secrets.GH_BOT_PRIVATE_KEY }}
        run: |
          echo "APP_ID set: $([ -n \"$GH_BOT_APP_ID\" ] && echo 'yes' || echo 'NO')"
          echo "APP_ID value: $GH_BOT_APP_ID"
          echo "INSTALLATION_ID set: $([ -n \"$GH_BOT_INSTALLATION_ID\" ] && echo 'yes' || echo 'NO')"
          echo "INSTALLATION_ID value: $GH_BOT_INSTALLATION_ID"
          echo "PRIVATE_KEY set: $([ -n \"$GH_BOT_PRIVATE_KEY\" ] && echo 'yes' || echo 'NO')"
          echo "PRIVATE_KEY length: ${#GH_BOT_PRIVATE_KEY}"
          echo "PRIVATE_KEY starts with: $(echo \"$GH_BOT_PRIVATE_KEY\" | head -c 30)"

      - name: Run pi
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_BOT_APP_ID: ${{ vars.GH_BOT_APP_ID }}
          GH_BOT_INSTALLATION_ID: ${{ vars.GH_BOT_INSTALLATION_ID }}
          GH_BOT_PRIVATE_KEY: ${{ secrets.GH_BOT_PRIVATE_KEY }}
          GH_BOT_HUMAN: ${{ vars.GH_BOT_HUMAN }}
          GH_BOT_AGENT: ${{ vars.GH_BOT_AGENT }}
        run: |
          npx @mariozechner/pi-coding-agent@latest -e ./pi-extensions/gh-bot -p "${{ steps.context.outputs.prompt }}" 2>&1 | tee /tmp/pi-output.log

      - name: Cost summary
        run: |
          echo "## ðŸ’° Cost Summary" >> $GITHUB_STEP_SUMMARY
          grep -iE "(token|cost|input|output|cache|\\\$[0-9])" /tmp/pi-output.log >> $GITHUB_STEP_SUMMARY || echo "No cost data found" >> $GITHUB_STEP_SUMMARY
